{% extends "base.html" %} {# Assumes base.html exists in src/templates/ #}

{% block title %}AI Note Taker & Analyzer{% endblock %}

{% block head_extra %}
    <!-- Load necessary libraries for report page AND dashboard chat -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    {# Load Socket.IO client from Flask-SocketIO or CDN #}
    <script src="/socket.io/socket.io.js"></script>
    {# If using CDN: <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script> #}
{% endblock %}


{% block content %}
    {# Main heading for the page #}
    <h1>AI Note Taker & Analyzer</h1>
    <p>Enter text below to generate a report and chat about it.</p>

    <!-- Input Area: Where the user enters text -->
    <div class="input-area form-group">
        <label for="inputText">Input Text:</label>
        <textarea id="inputText" rows="10" placeholder="Paste or type your text here..." class="form-control"></textarea>
        <button id="generateBtn" class="btn btn-primary btn-block mt-2">âœ¨ Generate Report</button>
    </div>

    <!-- Loading / Error Messages -->
    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
        <span id="loadingText">Loading...</span>
        <div class="spinner"></div>
    </div>
    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <!-- Report Display Area: Initially hidden -->
    <div id="reportContainer" style="display: none;" class="report-container mt-4">
        <div class="report-controls mb-3">
             <h2>Generated Report</h2>
             <button id="downloadPdfBtn" class="btn btn-success">Download PDF</button>
        </div>
        <div id="reportOutput" class="report-content"></div>
         <div class="charts-area mt-4">
             <h3>Data Visualizations</h3>
             <div id="keywordChartContainer" class="chart-container" style="display: none;"><canvas id="keywordChart"></canvas></div>
             <div id="sentimentChartContainer" class="chart-container" style="display: none;"><canvas id="sentimentChart"></canvas></div>
             <p id="noChartsMessage" style="display: none;">No relevant data found for charts.</p>
         </div>
    </div>

    <!-- Report-Specific Chat Area: Initially hidden, uses IDs like chatInput, sendChatBtn -->
    <div id="chatContainer" class="chat-container mt-4" style="display: none;">
        <h3>Chat About This Report</h3>
        <div id="chatMessages" class="chat-messages"></div>
        <div id="typingIndicator" class="typing-indicator" style="display: none;">AI is thinking...<span class="dot-flashing"></span></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Ask a question about the report..." disabled>
            <button id="sendChatBtn" class="btn btn-secondary" disabled>Send</button>
        </div>
    </div>

    {# --- START: Added Dashboard General Chat Section --- #}
    {# Conditionally show this only if user is logged in (using session data passed from Flask) #}
    {% if session.user_id %}
        <section class="dashboard-section dashboard-chat-section mt-4" id="general-chat-section">
            <h3>General Chat ðŸ’¬</h3>
            <p>Ask general questions here (not specific to the report above).</p>
            {# Use DIFFERENT IDs for dashboard chat elements #}
            <div id="dashboardChatMessages" class="chat-messages">
                <div class="message system">Connecting to general chat...</div>
            </div>
            <div id="dashboardTypingIndicator" class="typing-indicator" style="display: none;">
                AI is thinking...<span></span><span></span><span></span>
            </div>
            <div class="chat-input-area">
                <input type="text" id="dashboardChatInput" placeholder="Ask a general question..." disabled>
                <button id="sendDashboardChatBtn" class="btn btn-secondary" disabled>Send</button>
            </div>
             <div id="chatError" class="error-message" style="display: none;"></div> {# Maybe use a different ID e.g., dashboardChatError #}
        </section>
    {% else %}
        {# Optionally show a message or link to login if not logged in #}
        {# <p class="mt-4">Please <a href="{{ url_for('login') }}">login</a> to access the general chat.</p> #}
    {% endif %}
    {# --- END: Added Dashboard General Chat Section --- #}


{% endblock %}

{% block scripts %}
    <!-- Load the specific JS for THIS page (Report generation/chat) -->
    {# Load Firebase first if needed by script.js too #}
    <script type="module" src="{{ url_for('static', filename='js/script.js') }}"></script>

    <!-- Load the specific JS for the DASHBOARD CHAT (if user is logged in) -->
    {% if session.user_id %}
    <script type="module" src="{{ url_for('static', filename='script.js') }}"></script> {# Use a NEW, dedicated script #}
    {% endif %}
{% endblock %}